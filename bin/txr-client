#!/usr/bin/env node

!function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=10)}([function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("es6-promisify")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("socket.io-stream")},function(e,t){e.exports=require("socket.io-client")},function(e,t){e.exports=require("highlight.js")},function(e,t){e.exports=require("minimist")},function(e,t){e.exports=require("zip-dir")},function(e,t){e.exports=require("markdown-it")},function(e,t){e.exports=require("readline")},function(e,t,r){e.exports=r(12)},function(e,t){e.exports=require("colors")},function(e,t,r){"use strict";r.r(t);var n=r(6),i=r.n(n),s=r(4),o=r.n(s),a=r(3),c=r.n(a),u={filepath:process.env.TXR_PATH||process.env["win32"==process.platform?"USERPROFILE":"HOME"],server:{port:process.env.PORT||8e3,web_conc:process.env.WEB_CONCURRENCY||1,host:process.env.TXR_HOST||"https://txr.euphoritech.com"},redis:{url:process.env.REDIS_URL||"redis://localhost:6379"},logger:{options:{name:process.env.APP_NAME||"txr",level:process.env.LOGGING_LEVEL||"info",stream:process.stdout}}};function l(e,t,r,n,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,i)}function f(){var e;return e=function*({client:e,user:t,targetUser:r,host:n,reject:i,resolve:s}){const a=o.a.connect(n||u.server.host),c=e({socket:a,user:t,targetUser:r,host:n,reject:i,resolve:s});if(!t)return c.reject("Make sure you pass a user (-u or --username) to listen for files that could be sent to you.\n");if(!r)return c.reject("Make sure you pass a target user (-t or --target_user) to send chat messages to.\n");a.emit("txr-regiser-listen",{user:t});const l=c.chat;if(!l)return c.reject("The interface provided does not support the chat command.\n");const f=l.normal;Object.keys(f).forEach(e=>a.on(e,f[e].bind(l)))},(f=function(){var t=this,r=arguments;return new Promise(function(n,i){var s=e.apply(t,r);function o(e){l(s,n,i,o,a,"next",e)}function a(e){l(s,n,i,o,a,"throw",e)}o(void 0)})}).apply(this,arguments)}function d(e,t,r,n,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,i)}function h(){var e;return e=function*({client:e,file:t,user:r,auth:n,host:i,callback:s,reject:a,resolve:l}){const f=o.a.connect(i||u.server.host),d=e({socket:f,socketStream:c.a,file:t,user:r,auth:n,host:i,callback:s,reject:a,resolve:l});if(!r)return d.reject("Make sure you pass a user (-u or --username) to listen for files that could be sent to you.\n");f.emit("txr-regiser-listen",{user:r,auth:n});const h=d.listen,p=h.normal,y=h.stream;Object.keys(p).forEach(e=>f.on(e,p[e].bind(h))),Object.keys(y).forEach(e=>c()(f).on(e,y[e].bind(h)))},(h=function(){var t=this,r=arguments;return new Promise(function(n,i){var s=e.apply(t,r);function o(e){d(s,n,i,o,a,"next",e)}function a(e){d(s,n,i,o,a,"throw",e)}o(void 0)})}).apply(this,arguments)}var p=r(0),y=r.n(p),m=r(2),g=r.n(m),v=r(1),x=r.n(v),w=r(7),b=r.n(w),k=r(5),S=r.n(k),j=r(8);function $(e,t,r,n,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,i)}const T=new(r.n(j).a)({highlight:function(e,t){if(t&&S.a.getLanguage(t))try{return`<pre class="hljs"><code>${S.a.highlight(t,e,!0).value}</code></pre>`}catch(e){}return""}}),P=x()(y.a.readFile);var F={getFileName(e,t=Date.now()){const r=e.lastIndexOf("."),n=e.substring(r);return`${e.substring(0,r)}_${t}${n}`},expressjs:{convertReadmeToHtml(e){var t,r=this;return(t=function*(){const t=yield P("README.md","utf8"),n=T.render(t);return e.send(r.createHtmlPage(n))},function(){var e=this,r=arguments;return new Promise(function(n,i){var s=t.apply(e,r);function o(e){$(s,n,i,o,a,"next",e)}function a(e){$(s,n,i,o,a,"throw",e)}o(void 0)})})()},createHtmlPage:e=>`\n        <!DOCTYPE html>\n        <html>\n          <head>\n            <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />\n            <title>txr - Transfer Files to Friends</title>\n\n            <style>\n              body {\n                font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;\n              }\n\n              a {\n                color: inherit;\n              }\n\n              pre.hljs {\n                border-radius: 5px;\n                border: 1px solid #a0a0a0;\n                background: #f5f5f5;\n                overflow-x: scroll;\n                padding: 5px;\n              }\n\n              .container {\n                max-width: 700px;\n                margin-right: auto;\n                margin-left: auto;\n              }\n\n              .notice {\n                border-radius: 5px;\n                border: 1px solid #a0a0a0;\n                background: #28a745;\n                color: white;\n                padding: 15px;\n                margin: 25px 0px;\n              }\n            </style>\n          </head>\n\n          <body>\n            <div class="container">\n              <div class="notice">\n                You navigated to a txr server to transfer files easily to and\n                from machines/servers. Learn more below or by visiting\n                <a href="https://github.com/whatl3y/txr">https://github.com/whatl3y/txr</a>\n              </div>\n              ${e}\n            </div>\n          </body>\n        </html>\n      `}};r(11);var M={twoLinesDifferentColors(e,t,r="blue",n="green"){this.wrapInNewlines(()=>{e.length>0&&console.log(e[r]),t.length>0&&console.log(t[n])})},singleLine(e,t="blue",r=1){this.wrapInNewlines(()=>console.log(e[t]),r)},success(e){this.wrapInNewlines(()=>console.log(e.green))},error(e){this.wrapInNewlines(()=>console.log(e.red))},progress(e){process.stdout.write(e)},chatMessage(e){this.wrapInNewlines(()=>console.log(e.cyan))},wrapInNewlines(e=(()=>{}),t=0){const r=t-1>0?new Array(t-1).fill("\n").join(""):"";t>0&&console.log(r),e(),t>0&&console.log(r)}};function O(e,t,r,n,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,i)}function E(e){return function(){var t=this,r=arguments;return new Promise(function(n,i){var s=e.apply(t,r);function o(e){O(s,n,i,o,a,"next",e)}function a(e){O(s,n,i,o,a,"throw",e)}o(void 0)})}}const A=x()(y.a.access),N=x()(y.a.lstat),_=x()(y.a.writeFile),U=x()(b.a);function q(){return(q=E(function*({client:e,file:t,user:r,host:n,reject:i,resolve:s}){const a=o.a.connect(n||u.server.host),l=c.a.createStream(),f=e({socket:a,socketStream:c.a,writeStream:l,file:t,user:r,host:n,reject:i,resolve:s}),d=t,h=r;if(!d)return f.reject("Make sure you pass an absolute filepath (-f or --file) to send a file.\n");if(!h)return f.reject("Make sure you pass a user (-u or --username) to send a file to.\n");var p;if(!(yield(p=E(function*(e){try{return yield A(d),!0}catch(e){return!1}}),function(e){return p.apply(this,arguments)})(d)))return f.reject(`We couldn't find a file or directory located in the following location:\n${d}\n`);const m=yield N(d),v=m.isDirectory(),x=m.isFile();let w,b,k,S=m.size;if(v)M.success(`We are zipping and sending the directory: ${d}. This may take some time depending on how large the directory is...`),w=yield U(d),b=F.getFileName(`${d}.zip`),k=!0,S=`${S} (directory)`;else{if(!x)return f.reject(`The path specified is not a file or directory. The specified path needs to be a file or directory.\n${d}\n`);w=d,b=d}w instanceof Buffer&&(yield _(b,w));const j={filename:g.a.basename(b),filesizebytes:S,user:h};a.emit("txr-send-file-check-auth",j);const $=y.a.createReadStream(b),T=f.send;T.finalFilename=b,T.dataForFileToSend=j,T.deleteFileAfterSend=k;const P=T.normal,O=T.stream;Object.keys(P).forEach(e=>a.on(e,P[e].bind(T))),Object.keys(O).forEach(e=>$.on(e,O[e].bind(T))),$.pipe(l)})).apply(this,arguments)}var R={chat:function(e){return f.apply(this,arguments)},listen:function(e){return h.apply(this,arguments)},send:function(e){return q.apply(this,arguments)}},I=r(9),Y=r.n(I);function W(e=process.stdin,t=process.stdout){return{rl:Y.a.createInterface({input:e,output:t}),ask(e,t=!0){return new Promise((r,n)=>{this.rl.question(e,e=>{r(e),t&&this.close()})})},close(){this.rl.close()}}}function G(e,t,r,n,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,i)}function L(e){return function(){var t=this,r=arguments;return new Promise(function(n,i){var s=e.apply(t,r);function o(e){G(s,n,i,o,a,"next",e)}function a(e){G(s,n,i,o,a,"throw",e)}o(void 0)})}}const H=x()(y.a.unlink),z=e=>{M.error.bind(M)(e),process.exit()},C=process.exit;const D=()=>{};var J={cli:function({socket:e,socketStream:t,writeStream:r,file:n,user:i,targetUser:s,auth:o,host:a,reject:c,resolve:l}){return{reject:c=c||z,resolve:l=l||C,chat:{readline:null,waitAndSendMessage(){var t=this;return L(function*(){t.readline&&t.readline.close(),t.readline=W();const r=yield t.readline.ask(`[${i}]: `);if(["end","exit","quit"].includes(r)&&(M.success("Goodbye!"),l()),0===r.length)return yield t.waitAndSendMessage();e.emit("txr-send-chat-message",{user:i,targetUser:s,message:r}),yield t.waitAndSendMessage()})()},normal:{"txr-user-taken":function(){c(`The user you chose, ${i}, is already registered with the server. Please try another username.`)},"txr-destination-user-not-registered":function(e){c(`(There is no user currently registered with the username ${e}.)`)},"txr-receive-chat-message":(m=L(function*({targetUser:e,message:t}){M.chatMessage(`[${e}]: ${t}`),yield this.waitAndSendMessage()}),function(e){return m.apply(this,arguments)}),"txr-receive-reply":(p=L(function*({user:e,replyMessage:t}){this.readline&&(this.readline.close(),this.readonly=null),M.chatMessage(`[${e}]: ${t}`),yield this.waitAndSendMessage()}),function(e){return p.apply(this,arguments)}),"txr-user-registered-success":(h=L(function*(e){M.success(`Successfully registered name: ${e}. You can now send messages to ${s} below.\n`),M.success("(type 'exit' or 'quit' to stop sending messages)"),yield this.waitAndSendMessage()}),function(e){return h.apply(this,arguments)})}},listen:{readline:null,askToReply(t){var r=this;return L(function*(){r.readline&&r.readline.close(),r.readline=W();const n=yield r.readline.ask(`reply to ${t} - [${i}]: `);n.length>0?(e.emit("txr-reply-to-chat-message",{user:t,replyMessage:n}),M.success(`Thanks, your reply was sent to ${t}!`)):yield r.askToReply(t)})()},normal:{"txr-user-taken":function(){c(`The user you chose, ${i}, is already registered with the server. Please try another username.`)},"txr-user-registered-success":function(e){M.success(`Successfully registered name: ${e}. You are now listening for files.`)},"txr-file-permission":(d=L(function*(t){delete t.user;const r=yield W().ask(`\nSomeone wants to send you a file. Are you okay receiving a file with this data: ${JSON.stringify(t)} -- answer (yes/no): `);M.success(`You answered '${r}', we're letting the server and sender know now.`),e.emit("txr-file-permission-response",r)}),function(e){return d.apply(this,arguments)}),"txr-receive-chat-message":(f=L(function*({targetUser:e,message:t}){M.chatMessage(`[${e}]: ${t}`),yield this.askToReply(e)}),function(e){return f.apply(this,arguments)}),disconnect:function(){c("You were disconnected from the server.")}},stream:{"txr-file":function(e,t={}){delete t.user,M.success(`Starting to receive file with data: ${JSON.stringify(t)}`);const r=F.getFileName(t.filename||"txr.file"),n=g.a.join(u.filepath,g.a.basename(r)),i=y.a.createWriteStream(n);let s=0;e.on("data",e=>{s+=e.length,M.progress(".")}),e.on("error",e=>M.error(`\nError reading stream: ${e.toString()}`)),e.on("end",()=>{M.success(`\nFinished receiving file with data: ${JSON.stringify(t)}`),M.success(`Target file path: ${n}`)}),e.pipe(i)}}},send:{bytesTracker:0,dataForFileToSend:null,deleteFileAfterSend:!1,finalFilename:null,exitGracefully(e=(()=>{})){var t=this;return L(function*(){t.deleteFileAfterSend&&(yield H(t.finalFilename)),e(),l()})()},normal:{"txr-no-user":function(e){this.exitGracefully(()=>M.error(`No user registered with username: ${e.user}`))},"txr-file-permission-granted":function(){t(e).emit("txr-upload",r,this.dataForFileToSend)},"txr-file-permission-waiting":function(){M.success("Waiting for user to grant or reject receiving the file.")},"txr-file-permission-denied":function(){this.exitGracefully(()=>M.error("User did not grant permission to send file."))},"txr-file-data-hash-mismatch":function(){this.exitGracefully(()=>M.error("We can't validate the file you're sending."))},"txr-finished-uploading":function(){this.exitGracefully(()=>M.success(`Your file has successfully sent to ${i}!`))},disconnect:function(){this.exitGracefully(()=>M.error("You were disconnected from the server."))}},stream:{data:function(e){this.bytesTracker=this.bytesTracker+e.length,M.progress(".")},end:function(){M.success(`\nAll bytes have been read from file: ${this.finalFilename}.`)}}}};var f;var d;var h;var p;var m},library:function({socket:e,socketStream:t,writeStream:r,file:n,user:i,targetUser:s,host:o,logger:a,callback:c,reject:l,resolve:f}){return a=a||{debug:D,info:D},{reject:l,resolve:f,listen:{normal:{"txr-user-taken":function(){l(`The user you chose, ${i}, is already registered with the server. Please try another username.`)},disconnect:function(){l("You were disconnected from the server.")}},stream:{"txr-file":function(e,t={}){const r="function"==typeof c?c:f,n=F.getFileName(t.filename||"txr.file"),i=g.a.join(u.filepath,g.a.basename(n)),s=y.a.createWriteStream(i);let o=0;e.on("data",e=>{o+=e.length,a.debug(".")}),e.on("error",l),e.on("end",()=>r(i)),e.pipe(s)}}},send:{bytesTracker:0,dataForFileToSend:null,normal:{"txr-no-user":function(e){l(`No user registered with username: ${e.user}`)},"txr-file-permission-granted":function(){t(e).emit("txr-upload",r,this.dataForFileToSend)},"txr-file-permission-waiting":function(){a.info("Waiting for user to grant or reject receiving the file.")},"txr-file-permission-denied":function(){l("User did not grant permission to send file.")},"txr-file-data-hash-mismatch":function(){l("We can't validate the file you're sending.")},"txr-finished-uploading":function(){f(`Your file has successfully sent to ${i}!`)},disconnect:function(){l("You were disconnected from the server.")}},stream:{data:function(e){this.bytesTracker=this.bytesTracker+e.length,a.debug(".")},end:function(){a.info(`All bytes have been read from file: ${this.finalFilename}.`)}}}}}};function B(e,t,r,n,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,i)}function X(){var e;return e=function*({typeInterface:e,command:t,file:r,user:n,targetUser:i,auth:s,host:o,logger:a,callback:c,reject:u,resolve:l}){if(!e||!J[e])throw new Error(`We don't recognize the interface provided: ${e}`);{const f=J[e];if(!t||!R[t])throw new Error(`We don't recognize the command provided: ${t}`);yield R[t]({client:f,file:r,user:n,targetUser:i,auth:s,host:o,logger:a,callback:c,reject:u,resolve:l})}},(X=function(){var t=this,r=arguments;return new Promise(function(n,i){var s=e.apply(t,r);function o(e){B(s,n,i,o,a,"next",e)}function a(e){B(s,n,i,o,a,"throw",e)}o(void 0)})}).apply(this,arguments)}function V(e,t,r,n,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,i)}const K=i()(process.argv.slice(2)),Q=(re=K._,ne=3,function(e){if(Array.isArray(e))return e}(re)||function(e,t){var r=[],n=!0,i=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(n=(o=a.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw s}}return r}(re,ne)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()),Z=Q[0],ee=Q[1],te=Q[2];var re,ne;!function(){var e,t=(e=function*(){yield function(e){return X.apply(this,arguments)}({typeInterface:"cli",command:K.c||K.command||Z,file:K.f||K.file||K.d||K.dir||ee,user:K.u||K.username||K.user||te||ee,targetUser:K.t||K.target_user||K.targetUser||te,auth:K.a||K.auth,host:K.h||K.host})},function(){var t=this,r=arguments;return new Promise(function(n,i){var s=e.apply(t,r);function o(e){V(s,n,i,o,a,"next",e)}function a(e){V(s,n,i,o,a,"throw",e)}o(void 0)})});return function(){return t.apply(this,arguments)}}()()}]);