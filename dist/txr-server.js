#!/usr/bin/env node

!function(e){function t(n){if(r[n])return r[n].exports;var i=r[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var r={};t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=3)}([function(e,t){e.exports=require("socket.io-stream")},function(e,t){e.exports=require("bunyan")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={filepath:process.env.TXR_PATH||process.env["win32"==process.platform?"USERPROFILE":"HOME"],server:{port:process.env.PORT||8e3,web_conc:process.env.WEB_CONCURRENCY||1,host:process.env.TXR_HOST||"wss://txr.herokuapp.com"},logger:{options:{name:process.env.APP_NAME||"txr",level:process.env.LOGGING_LEVEL||"info",stream:process.stdout}}}},function(e,t,r){r(4),e.exports=r(5)},function(e,t){e.exports=require("babel-polyfill")},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}n(r(6)),n(r(7));var i=n(r(8)),o=n(r(9)),s=n(r(0)),u=n(r(1)),a=n(r(10)),c=n(r(13)),f=n(r(2)),d=u.default.createLogger(f.default.logger.options),l=(0,i.default)(process.argv.slice(2)),p=l.p||l.port||f.default.server.port;p=isNaN(p)?f.default.server.port:p;var m=(0,o.default)().listen(p);d.info("socket.io server listening on port: "+p),m.on("connection",function(e){d.info("got socket: "+e.id);var t=(0,s.default)(e),r=(0,a.default)(m,e,c.default);Object.keys(r.normal).forEach(function(t){return e.on(t,r.normal[t])}),Object.keys(r.stream).forEach(function(e){return t.on(e,r.stream[e])})})},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("minimist")},function(e,t){e.exports=require("socket.io")},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,r){return{normal:{"regiser-listen":function(e){var n=e.auth,i=e.user;r.names[i]?(t.emit("user-taken",!0),a.error("User could not register name: "+i)):(r.names[i]=t.id,r.ids[t.id]=i,r.auth[t.id]=!!n,t.emit("user-registered-success",i),a.info("User successfully registered name: "+i))},"send-file-check-auth":function(n){var i=n.filename,o=n.filesizebytes,u=n.user,c=r.names[u],f=r.auth[c],d=s.default.stringToHash(JSON.stringify({filename:i,filesizebytes:o,user:u}));if(u&&c){var l=e.sockets.connected[c];f?(t.emit("file-permission-waiting"),l.on("file-permission-response",function(e){"yes"===e.toLowerCase()?(r.unlocked[d]=t.id,t.emit("file-permission-granted")):t.emit("file-permission-denied")}),l.emit("file-permission",{filename:i,filesizebytes:o,user:u})):(r.unlocked[d]=t.id,t.emit("file-permission-granted"))}else a.error("Tried to send a file to '"+u+"' who has not registered."),t.emit("no-user",{user:u})},disconnect:function(){a.info("socket disconnected: "+t.id);var e=r.ids[t.id];delete r.ids[t.id],delete r.auth[t.id],delete r.names[e]}},stream:{upload:function(n,i){a.info("Received 'upload' event with data: "+JSON.stringify(i));var u=i.user,c=r.names[u],f=s.default.stringToHash(JSON.stringify(i));if(u&&c){if(r.unlocked[f]&&r.unlocked[f]==t.id){var d=e.sockets.connected[c],l=o.default.createStream();n.on("data",function(e){return a.info("Received "+e.length+" bytes of data.")}),n.on("error",function(e){return a.error("socket: "+t.id,e)}),n.on("end",function(){return a.info("Completed receiving file with data: "+JSON.stringify(i)+"!")}),l.on("end",function(){return t.emit("finished-uploading")}),n.pipe(l),(0,o.default)(d).emit("file",l,i)}else t.emit("file-data-hash-mismatch");delete r.unlocked[f]}else a.error("Tried to send a file to '"+u+"' who has not registered."),t.emit("no-user",{user:u})}}}};var i=n(r(1)),o=n(r(0)),s=n(r(11)),u=n(r(2)),a=i.default.createLogger(u.default.logger.options)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(e){return e&&e.__esModule?e:{default:e}}(r(12));t.default={stringToHash:function(e){var t=n.default.createHash("md5");return t.update(e),t.digest("hex")}}},function(e,t){e.exports=require("crypto")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={names:{},ids:{},auth:{},unlocked:{}}}]);