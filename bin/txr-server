#!/usr/bin/env node

!function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=12)}([function(e,t){e.exports=require("socket.io-stream")},function(e,t){e.exports=require("bunyan")},function(e,t){e.exports=require("highlight.js")},function(e,t){e.exports=require("minimist")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("socket.io")},function(e,t){e.exports=require("ioredis")},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("markdown-it")},function(e,t){e.exports=require("es6-promisify")},function(e,t,n){e.exports=n(13)},function(e,t,n){"use strict";n.r(t);var r=n(3),i=n.n(r),o=n(4),s=n.n(o),a=n(5),u=n.n(a),c=n(6),l=n.n(c),f=n(0),d=n.n(f),p=n(1),h=n.n(p),m=n(7),y=n.n(m),v=n(8),g=n.n(v),x={stringToHash(e){const t=g.a.createHash("md5");return t.update(e),t.digest("hex")}},b={filepath:process.env.TXR_PATH||process.env["win32"==process.platform?"USERPROFILE":"HOME"],server:{port:process.env.PORT||8e3,web_conc:process.env.WEB_CONCURRENCY||1,host:process.env.TXR_HOST||"https://txr.euphoritech.com"},redis:{url:process.env.REDIS_URL||"redis://localhost:6379"},logger:{options:{name:process.env.APP_NAME||"txr",level:process.env.LOGGING_LEVEL||"info",stream:process.stdout}}};function w(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{r||null==a.return||a.return()}finally{if(i)throw o}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function O(e,t,n,r,i,o,s){try{var a=e[o](s),u=a.value}catch(e){return void n(e)}a.done?t(u):Promise.resolve(u).then(r,i)}function P(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var o=e.apply(t,n);function s(e){O(o,r,i,s,a,"next",e)}function a(e){O(o,r,i,s,a,"throw",e)}s(void 0)})}}const k=h.a.createLogger(b.logger.options);var S=n(9),$=n.n(S),_=n(2),j=n.n(_),T=n(10),N=n.n(T),E=n(11),R=n.n(E);function q(e,t,n,r,i,o,s){try{var a=e[o](s),u=a.value}catch(e){return void n(e)}a.done?t(u):Promise.resolve(u).then(r,i)}const H=new N.a({highlight:function(e,t){if(t&&j.a.getLanguage(t))try{return`<pre class="hljs"><code>${j.a.highlight(t,e,!0).value}</code></pre>`}catch(e){}return""}}),A=R()($.a.readFile);var M={getFileName(e,t=Date.now()){const n=e.lastIndexOf("."),r=e.substring(n);return`${e.substring(0,n)}_${t}${r}`},expressjs:{convertReadmeToHtml(e){var t,n=this;return(t=function*(){const t=yield A("README.md","utf8"),r=H.render(t);return e.send(n.createHtmlPage(r))},function(){var e=this,n=arguments;return new Promise(function(r,i){var o=t.apply(e,n);function s(e){q(o,r,i,s,a,"next",e)}function a(e){q(o,r,i,s,a,"throw",e)}s(void 0)})})()},createHtmlPage:e=>`\n        <!DOCTYPE html>\n        <html>\n          <head>\n            <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />\n            <title>txr - Transfer Files to Friends</title>\n\n            <style>\n              body {\n                font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;\n              }\n\n              a {\n                color: inherit;\n              }\n\n              pre.hljs {\n                border-radius: 5px;\n                border: 1px solid #a0a0a0;\n                background: #f5f5f5;\n                overflow-x: scroll;\n                padding: 5px;\n              }\n\n              .container {\n                max-width: 700px;\n                margin-right: auto;\n                margin-left: auto;\n              }\n\n              .notice {\n                border-radius: 5px;\n                border: 1px solid #a0a0a0;\n                background: #28a745;\n                color: white;\n                padding: 15px;\n                margin: 25px 0px;\n              }\n            </style>\n          </head>\n\n          <body>\n            <div class="container">\n              <div class="notice">\n                You navigated to a txr server to transfer files easily to and\n                from machines/servers. Learn more below or by visiting\n                <a href="https://github.com/whatl3y/txr">https://github.com/whatl3y/txr</a>\n              </div>\n              ${e}\n            </div>\n          </body>\n        </html>\n      `}},L={paginateArray(e,t=9e7,n=1){const r=t*(n-1);if(e instanceof Array){const i=e.length;return{data:e.slice(r,r+t),number_of_pages:Math.ceil(i/t),current_page:n,data_length:i}}if("object"==typeof e&&null!=e){const o=e,s=Object.keys(o).sort(),a=s.length,u=s.slice(r,r+t);let c={};for(var i=0;i<u.length;i++)c[u[i]]=o[u[i]];return{data:c,number_of_pages:Math.ceil(a/t),current_page:n,data_length:a}}return e}};function J(e,t,n,r,i,o,s){try{var a=e[o](s),u=a.value}catch(e){return void n(e)}a.done?t(u):Promise.resolve(u).then(r,i)}function I({app:e}){return{"/clients"(t,n){return(r=function*(){const t=L.paginateArray(Object.keys(yield e.get("names")));n.json(t)},function(){var e=this,t=arguments;return new Promise(function(n,i){var o=r.apply(e,t);function s(e){J(o,n,i,s,a,"next",e)}function a(e){J(o,n,i,s,a,"throw",e)}s(void 0)})})();var r},"*"(e,t){M.expressjs.convertReadmeToHtml(t)}}}function C(e,t,n,r,i,o,s){try{var a=e[o](s),u=a.value}catch(e){return void n(e)}a.done?t(u):Promise.resolve(u).then(r,i)}function U(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var o=e.apply(t,n);function s(e){C(o,r,i,s,a,"next",e)}function a(e){C(o,r,i,s,a,"throw",e)}s(void 0)})}}function F(){return{app:{names:{},ids:{},auth:{},unlocked:{}},set(e,t,n){var r=this;return U(function*(){return r.app[e][t]=n})()},get(e,t=null){var n=this;return U(function*(){return t?n.app[e][t]:n.app[e]})()},del(e,t){var n=this;return U(function*(){delete n.app[e][t]})()}}}function G(e,t,n,r,i,o,s){try{var a=e[o](s),u=a.value}catch(e){return void n(e)}a.done?t(u):Promise.resolve(u).then(r,i)}function D(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var o=e.apply(t,n);function s(e){G(o,r,i,s,a,"next",e)}function a(e){G(o,r,i,s,a,"throw",e)}s(void 0)})}}var z={memory:F,redis:function(e){return{set:(t,n,r)=>D(function*(){let i=JSON.parse((yield e.get(`txr.${t}`))||"{}");return i[n]=r,yield e.set(`txr.${t}`,JSON.stringify(i)),r})(),get:(t,n=null)=>D(function*(){const r=JSON.parse((yield e.get(`txr.${t}`))||"{}");return n?r[n]:r})(),del:(t,n)=>D(function*(){let r=JSON.parse((yield e.get(`txr.${t}`))||"{}");delete r[n],yield e.set(`txr.${t}`,JSON.stringify(r))})(),flush:(t=Object.keys(F().app))=>D(function*(){return yield Promise.all(t.map((n=D(function*(t){yield e.del(`txr.${t}`)}),function(e){return n.apply(this,arguments)})));var n})()}}};function Y(e,{type:t}={}){const n=function e(t){switch(t){case"memory":return z.memory();case"redis":return z.redis(new y.a(b.redis.url));default:return e("memory")}}(t),r=u()(),i=s.a.Server(r),o=h.a.createLogger(b.logger.options),a=l()(i),c=I({app:n});return a.on("connection",function(e){o.info(`got socket: ${e.id}`);const t=d()(e),r=function(e,t,n){return{normal:{"txr-regiser-listen":(u=P(function*({auth:e,user:r}){(yield n.get("names",r))?(t.emit("txr-user-taken",!0),k.error(`User could not register name: ${r}`)):(yield Promise.all([n.set("names",r,t.id),n.set("ids",t.id,r),n.set("auth",t.id,!!e)]),t.emit("txr-user-registered-success",r),k.info(`User successfully registered name: ${r}`))}),function(e){return u.apply(this,arguments)}),"txr-send-file-check-auth":(a=P(function*({filename:r,filesizebytes:i,user:o}){const s=yield n.get("names",o),a=yield n.get("auth",s),u=x.stringToHash(JSON.stringify({filename:r,filesizebytes:i,user:o}));if(o&&s){const l=e.sockets.connected[s];a?(t.emit("txr-file-permission-waiting"),l.on("file-permission-response",(c=P(function*(e){"yes"===e.toLowerCase()?(yield n.set("unlocked",u,t.id),t.emit("txr-file-permission-granted")):t.emit("txr-file-permission-denied")}),function(e){return c.apply(this,arguments)})),l.emit("txr-file-permission",{filename:r,filesizebytes:i,user:o})):(yield n.set("unlocked",u,t.id),t.emit("txr-file-permission-granted"))}else k.error(`Tried to send a file to '${o}' who has not registered.`),t.emit("txr-no-user",{user:o});var c}),function(e){return a.apply(this,arguments)}),"txr-send-chat-message":(s=P(function*({targetUser:r,user:i,message:o}){const s=yield n.get("names",r);if(!s)return t.emit("txr-destination-user-not-registered",r);e.sockets.connected[s].emit("txr-receive-chat-message",{targetUser:i,message:o})}),function(e){return s.apply(this,arguments)}),"txr-reply-to-chat-message":(o=P(function*({user:r,replyMessage:i}){const o=w(yield Promise.all([n.get("ids",t.id),n.get("names",r)]),2),s=o[0],a=o[1];a&&e.sockets.connected[a].emit("txr-receive-reply",{user:s,replyMessage:i})}),function(e){return o.apply(this,arguments)}),disconnect:(i=P(function*(){k.info(`socket disconnected: ${t.id}`);const e=yield n.get("ids",t.id);yield Promise.all([n.del("ids",t.id),n.del("auth",t.id),n.del("names",e)])}),function(){return i.apply(this,arguments)})},stream:{"txr-upload":(r=P(function*(r,i){k.info(`Received 'upload' event with data: ${JSON.stringify(i)}`);const o=i.user,s=yield n.get("names",o),a=x.stringToHash(JSON.stringify(i));if(o&&s){const o=yield n.get("unlocked",a);if(o&&o==t.id){const n=e.sockets.connected[s],o=d.a.createStream();r.on("data",e=>k.info(`Received ${e.length} bytes of data.`)),r.on("error",e=>k.error(`socket: ${t.id}`,e)),r.on("end",()=>k.info(`Completed receiving file with data: ${JSON.stringify(i)}!`)),o.on("end",()=>t.emit("txr-finished-uploading")),r.pipe(o),d()(n).emit("txr-file",o,i)}else t.emit("txr-file-data-hash-mismatch");yield n.del("unlocked",a)}else k.error(`Tried to send a file to '${o}' who has not registered.`),t.emit("txr-no-user",{user:o})}),function(e,t){return r.apply(this,arguments)})}};var r;var i;var o;var s;var a;var u}(a,e,n);Object.keys(r.normal).forEach(t=>e.on(t,r.normal[t])),Object.keys(r.stream).forEach(e=>t.on(e,r.stream[e]))}),Object.keys(c).forEach(e=>r.get(e,c[e])),i.listen(e,()=>o.info(`server listening on *: ${e}`)),{app:r,httpServer:i,socketApp:n}}function X(e,t,n,r,i,o,s){try{var a=e[o](s),u=a.value}catch(e){return void n(e)}a.done?t(u):Promise.resolve(u).then(r,i)}function B(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var o=e.apply(t,n);function s(e){X(o,r,i,s,a,"next",e)}function a(e){X(o,r,i,s,a,"throw",e)}s(void 0)})}}const V=()=>{},W=i()(process.argv.slice(2)),K=W.t||W.type||"memory";let Q=W.p||W.port||b.server.port;function Z(){return ee.apply(this,arguments)}function ee(){return(ee=B(function*(e=V){"function"==typeof e&&(yield e()),process.exit()})).apply(this,arguments)}Q=isNaN(Q)?b.server.port:Q,function(){var e=B(function*(){const e=(yield Y(Q,{type:K})).socketApp;process.on("SIGINT",()=>Z(e.flush)),process.on("SIGTERM",()=>Z(e.flush))});return function(){return e.apply(this,arguments)}}()()}]);