#!/usr/bin/env node

!function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=3)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={filepath:process.env.TXR_PATH||process.env["win32"==process.platform?"USERPROFILE":"HOME"],server:{port:process.env.PORT||8e3,web_conc:process.env.WEB_CONCURRENCY||1,host:process.env.TXR_HOST||"https://txr.euphoritech.com"},logger:{options:{name:process.env.APP_NAME||"txr",level:process.env.LOGGING_LEVEL||"info",stream:process.stdout}}}},function(e,t){e.exports=require("socket.io-stream")},function(e,t){e.exports=require("bunyan")},function(e,t,n){e.exports=n(4)},function(e,t,n){"use strict";var r=o(n(5)),s=o(n(6)),i=o(n(0));function o(e){return e&&e.__esModule?e:{default:e}}const a=(0,r.default)(process.argv.slice(2));let u=a.p||a.port||i.default.server.port;u=isNaN(u)?i.default.server.port:u,async function(){await(0,s.default)(u)}()},function(e,t){e.exports=require("minimist")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){const t=(0,s.default)(),n=r.default.Server(t),f=a.default.createLogger(l.default.logger.options),p=(0,i.default)(n);return t.get("*",(e,t)=>d.default.expressjs.convertReadmeToHtml(t)),n.listen(e,()=>f.info(`server listening on *: ${e}`)),p.on("connection",function(e){f.info(`got socket: ${e.id}`);const t=(0,o.default)(e),n=(0,u.default)(p,e,c.default);Object.keys(n.normal).forEach(t=>e.on(t,n.normal[t])),Object.keys(n.stream).forEach(e=>t.on(e,n.stream[e]))}),{app:t,httpServer:n}};var r=f(n(7)),s=f(n(8)),i=f(n(9)),o=f(n(1)),a=f(n(2)),u=f(n(10)),c=f(n(13)),d=f(n(14)),l=f(n(0));function f(e){return e&&e.__esModule?e:{default:e}}},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("socket.io")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n){return{normal:{"txr-regiser-listen":function({auth:e,user:r}){n.names[r]?(t.emit("txr-user-taken",!0),u.error(`User could not register name: ${r}`)):(n.names[r]=t.id,n.ids[t.id]=r,n.auth[t.id]=!!e,t.emit("txr-user-registered-success",r),u.info(`User successfully registered name: ${r}`))},"txr-send-file-check-auth":function({filename:r,filesizebytes:s,user:o}){const a=n.names[o],c=n.auth[a],d=i.default.stringToHash(JSON.stringify({filename:r,filesizebytes:s,user:o}));if(o&&a){const i=e.sockets.connected[a];c?(t.emit("txr-file-permission-waiting"),i.on("file-permission-response",e=>{"yes"===e.toLowerCase()?(n.unlocked[d]=t.id,t.emit("txr-file-permission-granted")):t.emit("txr-file-permission-denied")}),i.emit("txr-file-permission",{filename:r,filesizebytes:s,user:o})):(n.unlocked[d]=t.id,t.emit("txr-file-permission-granted"))}else u.error(`Tried to send a file to '${o}' who has not registered.`),t.emit("txr-no-user",{user:o})},"txr-send-chat-message":function({targetUser:r,user:s,message:i}){const o=n.names[r];if(!o)return t.emit("txr-destination-user-not-registered",r);const a=e.sockets.connected[o];a.emit("txr-receive-chat-message",{targetUser:s,message:i})},"txr-reply-to-chat-message":function({user:r,replyMessage:s}){const i=n.ids[t.id],o=n.names[r];if(o){const t=e.sockets.connected[o];t.emit("txr-receive-reply",{user:i,replyMessage:s})}},disconnect:function(){u.info(`socket disconnected: ${t.id}`);const e=n.ids[t.id];delete n.ids[t.id],delete n.auth[t.id],delete n.names[e]}},stream:{"txr-upload":function(r,o){u.info(`Received 'upload' event with data: ${JSON.stringify(o)}`);const a=o.user,c=n.names[a],d=i.default.stringToHash(JSON.stringify(o));if(a&&c){if(n.unlocked[d]&&n.unlocked[d]==t.id){const n=e.sockets.connected[c],i=s.default.createStream();r.on("data",e=>u.info(`Received ${e.length} bytes of data.`)),r.on("error",e=>u.error(`socket: ${t.id}`,e)),r.on("end",()=>u.info(`Completed receiving file with data: ${JSON.stringify(o)}!`)),i.on("end",()=>t.emit("txr-finished-uploading")),r.pipe(i),(0,s.default)(n).emit("txr-file",i,o)}else t.emit("txr-file-data-hash-mismatch");delete n.unlocked[d]}else u.error(`Tried to send a file to '${a}' who has not registered.`),t.emit("txr-no-user",{user:a})}}}};var r=a(n(2)),s=a(n(1)),i=a(n(11)),o=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}const u=r.default.createLogger(o.default.logger.options)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,s=n(12),i=(r=s)&&r.__esModule?r:{default:r};t.default={stringToHash(e){const t=i.default.createHash("md5");return t.update(e),t.digest("hex")}}},function(e,t){e.exports=require("crypto")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={names:{},ids:{},auth:{},unlocked:{}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=a(n(15)),s=a(n(16)),i=a(n(17)),o=a(n(18));function a(e){return e&&e.__esModule?e:{default:e}}const u=new i.default({highlight:function(e,t){if(t&&s.default.getLanguage(t))try{return`<pre class="hljs"><code>${s.default.highlight(t,e,!0).value}</code></pre>`}catch(e){}return""}}),c=(0,o.default)(r.default.readFile);t.default={getFileName(e,t=Date.now()){const n=e.lastIndexOf("."),r=e.substring(n);return`${e.substring(0,n)}_${t}${r}`},expressjs:{async convertReadmeToHtml(e){const t=await c("README.md","utf8"),n=u.render(t);return e.send(this.createHtmlPage(n))},createHtmlPage:e=>`\n        <!DOCTYPE html>\n        <html>\n          <head>\n            <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />\n            <title>txr - Transfer Files to Friends</title>\n\n            <style>\n              body {\n                font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;\n              }\n\n              a {\n                color: inherit;\n              }\n\n              pre.hljs {\n                border-radius: 5px;\n                border: 1px solid #a0a0a0;\n                background: #f5f5f5;\n                overflow-x: scroll;\n                padding: 5px;\n              }\n\n              .container {\n                max-width: 700px;\n                margin-right: auto;\n                margin-left: auto;\n              }\n\n              .notice {\n                border-radius: 5px;\n                border: 1px solid #a0a0a0;\n                background: #28a745;\n                color: white;\n                padding: 15px;\n                margin: 25px 0px;\n              }\n            </style>\n          </head>\n\n          <body>\n            <div class="container">\n              <div class="notice">\n                You navigated to a txr server to transfer files easily to and\n                from machines/servers. Learn more below or by visiting\n                <a href="https://github.com/whatl3y/txr">https://github.com/whatl3y/txr</a>\n              </div>\n              ${e}\n            </div>\n          </body>\n        </html>\n      `}}},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("highlight.js")},function(e,t){e.exports=require("markdown-it")},function(e,t){e.exports=require("es6-promisify")}]);